### CMN700

[toc]

#### CMN-700 中HNF/HNI/HNP区别 { .unnumbered .unlisted }

##### Home Node 基础 { .unnumbered .unlisted }

每个HN（Home Node）负责管理全部地址空间中的部分地址空间。每个HN具体管理哪个地址空间是由SAM表来决定的。每个节点管理若干个地址，而每个地址只属于一个唯一的HNF节点。HN节点负责管理这些地址对应的缓存一致性信息，并按序处理发生在这些地址上的一致性请求。

##### HNF { .unnumbered .unlisted }

全部的DRAM空间由所有的HNF来管理。

HNF：

1. **System Level Cache** ： The System Level Cache (SLC) is a last-level cache. The SLC allocation policy is exclusive for data lines, except where sharing patterns are detected and pseudo-inclusive for code lines, as indicated by the RN‑Fs. All code lines can be allocated into the SLC on the initial request. When MTE is enabled, SLC stores data and tags.
1. **Combined PoS/PoC** ： The combined Point-of-Serialization/Point-of-Coherency (PoS/PoC) is responsible for the ordering of all memory requests sent to the HN‑F. Ordering includes serialization of multiple outstanding requests and actions to the same line, and request ordering as required by the RN‑F.
1. **Snoop Filter** ： The Snoop Filter (SF) tracks cachelines that are present in the RN‑Fs. It reduces snoop traffic in the system by favoring directed snoops over snoop broadcasts when possible. This approach substantially reduces the snoop response traffic that might otherwise be required.

问题：按照基本概念理解，基于snoop的缓存一致性协议，会产生多播或广播，占用较大的片内带宽，而基于目录的缓存一致性协议按道理只需要单播通信，占用网络带宽较低。为什么基于目录的缓存一致性协议还需要Snoop Filter？

Ans：基于目录的缓存一致性协议不能完全杜绝一对多的多播通信。例如，HN 可能会对多有共享某个缓存数据块的节点发送invalid操作。

##### HNI { .unnumbered .unlisted }

The I/O coherent Home Node (HN‑I) is a Home Node for all CHI transactions targeting AMBA subordinate devices

The HN‑I acts as a proxy for all the RNs of CMN‑700, converting CHI transactions to ACE5-Lite transactions. The HN‑I includes support for the correct ordering of Arm device types.

The HN‑I does not support caching of any data read from or written to the downstream ACE5-Lite I/O subordinate subsystem. Any cacheable request that is sent to the HN‑I does not result in any snoops being sent to RN‑Fs in the system. Instead, the request is converted to the appropriate ACE5-Lite read or write command and sent to the downstream ACE5-Lite subsystem.

If an RN‑F caches data that is read from or written to the downstream ACE5-Lite I/O subordinate subsystem, coherency is not maintained. Any subsequent access to that data reads from or writes to the ACE5-Lite I/O subordinate subsystem directly, ignoring the cached data

There are HN‑I types with extra functionality. These types include:

* HN-T
  HN-I that has a debug trace controller and DVM Node.
  CMN‑700 can have zero or more HN‑I and HN‑T instances.

* HN-D
  HN-I that has a debug trace controller, DVM Node, and configuration subordinate.
  CMN‑700 must have exactly one HN‑D instance.

* HN-P
  HN‑I that is optimized for peer-to-peer PCIe traffic.

* HN-V
  A device that includes an HN‑I and DVM Node (DN).

##### HNP { .unnumbered .unlisted }

The I/O coherent Home Node with PCIe optimization (HN‑P) is a device that includes the HN‑I
functionality and dedicated trackers for PCIe peer-to-peer traffic.
HN‑P can only be used to connect to PCIe subordinates.

<!-- mdbook-pandoc::table: 14|48|49|40 -->
|节点类型|HNF|HNI|HNP|
|------------|---|---|---|
|**功能**|System Level Cache Combined PoS/PoC Snoop Filter|充当所有下游节点的代理，转换 CHI 事务为 ACE5-Lite|包含 HNI 功能，专为 PCIe  P2P流量设计|
|**缓存一致性**|Yes|不维护缓存一致性，直接访问下游设备|不维护缓存一致性，直接访问 PCIe 从属设备|
|**数据处理**|缓存并影响数据访问|直接翻译请求为 ACE5-Lite 命令|跟踪并优化 PCIe 相关的数据交换|
|**连接目标**|NA|可连接 AMBA 从属设备|仅连接 PCIe 从属设备|
|**复杂性**|增加缓存一致性维护的复杂性|简化处理，避免缓存一致性问题|简化处理，优化 PCIe 相关流量|