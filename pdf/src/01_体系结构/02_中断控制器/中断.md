### 中断

[toc]

#### 异常向量表 { .unnumbered .unlisted }

当异常发生时，处理器必须跳转和执行与异常相关的处理指令。异常相关的处理指令通常
存储在内存中， 这个存储位置称为异常向量。 在 ARM 体系结构中， 异常向量存储在一个表中，
称为异常向量表。在 ARMv8 体系结构中，每个异常级别都有自己的向量表，即 EL3、 EL2 和
EL1 各有一个异常向量表。

**ARMv7 体系结构的异常向量表比较简单，ARMv7架构中的异常向量表地址从0x00000000开始， 每个表项是 4 字节， 每个表项里存放了一条跳转指令。** 但是 ARMv8 的异常向量表发生了变化， 每一个表项是 128 字节， 这样可以存放 32 条指
令。注意， ARMv8 指令集支持 64 位指令集，但是每一条指令的位宽是 32 位，而不是 64 位。

ARMv8 的异常向量表存放的基地址可以通过向量基址寄存器（ Vector Base Address Register， VBAR）来设置。

**ARM M7 是Arm v7架构，32位。**

一个示例：

![image-20240710140146524](book/pdf/src/01_体系结构/02_中断控制器/images/中断/image-20240710140146524.png)

````c
Address       Exception Type
0x00000000    Reset
0x00000004    Undefined Instruction
0x00000008    Software Interrupt (SWI)
0x0000000C    Prefetch Abort
0x00000010    Data Abort
0x00000014    Reserved
0x00000018    IRQ
0x0000001C    FIQ

````

跳入异常向量表操作是异常发生时，硬件自动完成的，剩下的异常处理任务完全交给了程序员。由上表可知，异常向量是一个固定的内存地址，我们可以通过向该地址处写一条跳转指令，让它跳向我们自己定义的异常处理程序的入口，就可以完成异常处理了。

#### 中断与异常区别 { .unnumbered .unlisted }

##### 中断（Interrupt） { .unnumbered .unlisted }

**中断**是由外部设备（如I/O设备、定时器等）发出的信号，通知处理器需要处理某个事件。中断通常是异步的，即它们可以在任何时间发生，并且与处理器当前执行的指令无关。

###### 特点： { .unnumbered .unlisted }

1. **异步性**：中断可以在任何时间发生，不依赖于当前指令的执行状态。
1. **外部事件触发**：通常由外部硬件设备触发，例如键盘输入、中断请求线（IRQ）等。
1. **中断向量**：每个中断通常都有一个对应的中断向量，用于指向相应的中断处理程序。
1. **优先级和嵌套**：中断控制器（如NVIC或GIC）可以管理中断的优先级和嵌套。
1. **响应中断**：处理器在中断发生时，会保存当前的执行状态，然后跳转到相应的中断处理程序。

###### 示例： { .unnumbered .unlisted }

* 定时器中断
* 键盘中断
* 网络中断

##### 异常（Exception） { .unnumbered .unlisted }

**异常**是由处理器在执行指令过程中检测到的特殊情况或错误条件。这些情况通常是同步的，即在执行特定指令时发生。

###### 特点： { .unnumbered .unlisted }

1. **同步性**：异常在特定指令执行过程中发生，是指令执行的结果。
1. **内部事件触发**：由处理器内部条件触发，例如非法指令、除零错误、页面错误等。
1. **异常向量**：每种异常类型都有一个对应的异常向量，用于指向相应的异常处理程序。
1. **处理机制**：处理器在检测到异常时，会停止当前指令的执行，保存状态，并跳转到相应的异常处理程序。
1. **恢复执行**：在处理完异常后，通常会尝试恢复执行被中断的指令或进行适当的错误处理。

###### 示例： { .unnumbered .unlisted }

* 未定义指令异常
* 除零错误
* 页面错误

<!-- mdbook-pandoc::table: 8|20|34 -->
|特点|中断（Interrupt）|异常（Exception）|
|------|---------------------|---------------------|
|触发源|外部设备|处理器内部|
|时间|异步|同步|
|处理方式|中断处理程序|异常处理程序|
|优先级|可以有优先级和嵌套|一般没有嵌套处理|
|保存状态|保存处理器状态|保存处理器状态|
|恢复执行|处理完中断后恢复执行|处理完异常后尝试恢复执行或终止程序|

#### 中断 { .unnumbered .unlisted }

在 ARM 体系结构里，中断是属于异步异常的一种，其处理过程与异常处理很类似。

ARM64 处理器有两个与中断相关的引脚——nIRQ 和 nFIQ 。

这两个引脚直
接连接到 ARM64 处理器内核上。 ARM 处理器把中断请求分成普通 IRQ（Interrupt Request）和 FIQ（Fast Interrupt Request）两种。

PSTATE 寄存器里面有两位与中断相关，它们相当于 CPU 内核的中断总开关。
 I：用来屏蔽和打开 IRQ。
 F：用来屏蔽和打开 FIQ。

![image-20240710144034412](book/pdf/src/01_体系结构/02_中断控制器/images/中断/image-20240710144034412.png)

![image-20240710143838604](book/pdf/src/01_体系结构/02_中断控制器/images/中断/image-20240710143838604.png)

#### 中断控制器NVIC与GIC { .unnumbered .unlisted }

![image-20240710143621431](book/pdf/src/01_体系结构/02_中断控制器/images/中断/image-20240710143621431.png)

##### NVIC（Nested Vectored Interrupt Controller） { .unnumbered .unlisted }

**NVIC** 是一种嵌套向量中断控制器，主要用于Cortex-M系列处理器。这些处理器通常用于微控制器和低功耗设备。NVIC的主要特点包括：

1. **嵌套中断**：
   * 支持中断嵌套，中断优先级可以设置，使高优先级中断可以打断低优先级中断。
   * 每个中断都有一个唯一的优先级，可以通过编程设置。
1. **集成度高**：
   * NVIC是Cortex-M处理器内核的一部分，紧密集成在处理器内部。
   * 通过内存映射的寄存器控制。
1. **低延迟**：
   * 由于NVIC是处理器内核的一部分，中断响应时间非常快，适合实时应用。
1. **特性**：
   * 提供向量表偏移寄存器（VTOR）以支持动态中断向量表。
   * 支持多达240个中断（具体数量取决于具体的Cortex-M型号）。

##### GIC（Generic Interrupt Controller） { .unnumbered .unlisted }

**GIC** 是一种通用中断控制器，主要用于Cortex-A系列处理器，这些处理器通常用于高性能应用，如嵌入式系统、智能手机和服务器。GIC的主要特点包括：

1. **支持多个处理器**：
   * GIC支持多核系统，可以在多个处理器之间分发中断。
   * 包括两个主要组件：分配器（Distributor）和CPU接口（CPU Interface）。
1. **高级中断管理**：
   * 支持更复杂的中断管理机制，包括中断优先级、中断屏蔽和中断路由。
   * 可以配置每个中断的目标处理器和优先级。
1. **扩展性强**：
   * 设计用于处理大量中断，可以支持多达1020个中断（具体数量取决于具体实现）。
   * GICv3和GICv4进一步增加了中断管理能力，支持更多的中断和更复杂的配置。
1. **独立于处理器内核**：
   * GIC是一个独立的模块，通常与处理器分开实现，可以放置在片上系统（SoC）的不同位置。
   * 通过内存映射的寄存器进行配置和控制。

##### 总结 { .unnumbered .unlisted }

* **NVIC**：
  * 主要用于**Cortex-M**系列处理器。
  * 高度集成，低延迟，适合实时应用。
  * 支持嵌套中断和优先级管理。
* **GIC**：
  * 主要用于**Cortex-A**系列处理器。
  * 支持**多核系统和复杂的中断管理**。
  * 独立于处理器内核，实现灵活的中断分发和配置。