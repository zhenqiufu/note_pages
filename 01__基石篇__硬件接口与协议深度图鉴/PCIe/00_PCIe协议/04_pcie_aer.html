<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>pcie aer</title>


        <!-- Custom HTML head -->

        <meta name="description" content="涵盖硬件接口、芯片设计、固件开发、内核协同、AI基础设施的全栈技术知识库">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="aer"><a class="header" href="#aer">AER</a></h1>
<p>[toc]</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>在使用PCIe协议作为通信管道时候，任何位置都有可能出错，而PCIe关注的则是下图中虚线框内的部分，其他部分的错误，则由上层应用来进行处理。</p>
<p><img src="images/04_pcie_aer/image-20240806094751000.png" alt="image-20240806094751000" /></p>
<h2 id="错误分类"><a class="header" href="#错误分类">错误分类</a></h2>
<p>pcie 将错误分成两大类， Uncorrectable errors 和 Correctable errors，其中 Uncorrectable errors 又被分成 Fatal 和 Non-Fatal。</p>
<p><img src="images/04_pcie_aer/image-20240806094740419.png" alt="image-20240806094740419" /></p>
<p>pcie 将错误处理分成两种模式：baseline capability 和 Advanced Error Reporting capability。其中 baseline capability 是所有 pcie 都需要支持的，而 aer 是可选的。</p>
<p>Correctable errors 是指 pcie 自身可以修正的错误，比如 pcie 的 DLLP 会对数据包加上 LCRC ，并使用重传机制来修正传输过程中出现的 LCRC 错误，因此可以不需要软件参与。 Correctable errors 的上报对于软件来说主要是用来检测、统计 pcie hierarchy 的状态。</p>
<p>相对的 Uncorrectable errors 就是指 pcie 自身无法修正的错误，需要由软件去处理。pcie 将 Uncorrectable errors 分成 Fatal 和 Non-Fatal，其中 Non-Fatal 错误可以简单的理解成是某一个 tlp 发生了问题，可能设备驱动自己就可以处理这些错误，而 Fatal 错误（与 pci 的 SERR# 类似）更多的是硬件链路的问题，这个时候整个 segment（后面会讲）可能都无法正常使用了，并且需要去 reset 整个 pcie device 才能恢复。这也是为什么要将Uncorrectable errors 再进行细分的原因，尽可能地缩小影响范围。</p>
<h3 id="每层可能出现的错误"><a class="header" href="#每层可能出现的错误">每层可能出现的错误</a></h3>
<p><img src="images/04_pcie_aer/image-20240806095459263.png" alt="image-20240806095459263" /></p>
<p><img src="images/04_pcie_aer/image-20240806095509436.png" alt="image-20240806095509436" /></p>
<p><img src="images/04_pcie_aer/image-20240806095521149.png" alt="image-20240806095521149" /></p>
<p>上面列出了物理层、数据链路层和传输层的各种错误，并标识了默认配置下这些错误是 Correctable errors 还是 Fatal 或者 Non-Fatal 的。</p>
<p>这里需要注意的是，对于 Non-Fatal 和 Fatal 的错误严重级别判定可能是和 platform 相关的，比如 Malformed TLP 默认情况是一个 Fatal 错误，但是 Malformed TLP 看起来并不会对系统或者 pcie 设备产生非常大的影响，因此 aer 提供了寄存器，软件可以设置Uncorrectable errors 为 Fatal 或者 Non-Fatal 。</p>
<p>同时 aer 也提供寄存器可以单独设置 mask 某个错误的上报，常见比如 Correctable errors 是 pcie 自身可以处理的错误，软件可能并不需要这些信息，mask 掉还可以节省一些带宽。</p>
<h2 id="错误上报"><a class="header" href="#错误上报">错误上报</a></h2>
<p>pcie 提供两种错误上报机制，一种是 Completion Status 另一种是 error Messages（in-band）。</p>
<h3 id="completion-status"><a class="header" href="#completion-status">Completion Status</a></h3>
<p>对于 non-posted 的传输，Completion Header 中包含 Completion Status 用于返回错误状态。这是唯一一种错误上报的方法可以让 Requestor 可以直接关联相应的错误到具体某一个 request TLP 上。</p>
<p><img src="images/04_pcie_aer/image-20240806102537276.png" alt="image-20240806102537276" /></p>
<p>如下图，ep0 发送一个 mem read tlp 想要读取 ep1 的信息（1），这个时候 ep1 可以因为暂时的原因，比如数据还没有准备好，可以给 ep0 返回一个 UR 的 Completion tlp（2），ep0 的 app logic 可以选择隔一段时间再向 ep1 发出请求，或者记录下这一次 mem read tlp 信息并发送 error message 告知 rp（3）。</p>
<p><img src="images/04_pcie_aer/image-20240806102644838.png" alt="image-20240806102644838" /></p>
<h3 id="error-messages"><a class="header" href="#error-messages">error Messages</a></h3>
<p>error Messages 的包格式如下，可以看到 error Messages 是直接路由到 rp 的，需要 rp 去处理，其中 error message 中包含了 Requester ID 信息，rp 会将这个 Requester ID 保存起来，方便软件追踪问题。</p>
<p><img src="images/04_pcie_aer/image-20240806103349804.png" alt="image-20240806103349804" /></p>
<p>如下图，仍然是 ep0 发送一个 mem read tlp 想要读取 ep1 的信息（1），但是这个 tlp 发送到 switch 右侧的 port 时就已经发生错误，这个时候 ep1 就收不到这个 tlp，由 switch 记录下这个 tlp 信息并向 rp 发送 error message（2） 。ep0 由于长时间收不到应答（completion timeout）也将向 rp 发送 error message（3）。</p>
<p><img src="images/04_pcie_aer/image-20240806103447787.png" alt="image-20240806103447787" /></p>
<h2 id="错误记录"><a class="header" href="#错误记录">错误记录</a></h2>
<p>pcie 在处理错误时会尽量的将错误信息记录下来，方便软件处理的时候更容易找到错误的源头。</p>
<p>错误记录和错误上报类似，同样有两种方式，一种是device status，一种是AER。</p>
<h3 id="device-status"><a class="header" href="#device-status">Device Status</a></h3>
<p>对于不支持 aer 的 pcie 设备，只能通过 Device Status 状态寄存器来保存错误的信息，如下，只有一个简单的标志。</p>
<p><img src="images/04_pcie_aer/image-20240806103614888.png" alt="image-20240806103614888" /></p>
<p>部分错误也会映射到 PCI status （软件上的向后兼容）寄存器中：</p>
<p><img src="images/04_pcie_aer/image-20240806103646382.png" alt="image-20240806103646382" /></p>
<h3 id="aer-1"><a class="header" href="#aer-1">AER</a></h3>
<p>aer 大大扩展了错误记录的能力，如下 aer 提供的 status 寄存器可以更详细的记录发生了哪个错误，并且对于 Transaction Layer 产生的错误，也会将具体出错的 TLP 的 header 信息保存到寄存器中，软件可以借助这个信息定位到具体发生错误的 tlp ：</p>
<h2 id="错误上报流程"><a class="header" href="#错误上报流程">错误上报流程</a></h2>
<p><img src="images/04_pcie_aer/image-20240806103823152.png" alt="image-20240806103823152" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../01__基石篇__硬件接口与协议深度图鉴/PCIe/00_PCIe协议/03_pcie_eq.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../01__基石篇__硬件接口与协议深度图鉴/PCIe/00_PCIe协议/05_PCIe_clk.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../01__基石篇__硬件接口与协议深度图鉴/PCIe/00_PCIe协议/03_pcie_eq.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../01__基石篇__硬件接口与协议深度图鉴/PCIe/00_PCIe协议/05_PCIe_clk.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
